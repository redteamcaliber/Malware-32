// cppSockets.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"
#include <windows.h>
#include <winsock.h>

void ReportError(int, const char*);

int _tmain(int argc, _TCHAR* argv[])
{
	struct sockaddr_in{
		short sin_family; //Protocol type
		u_short sin_port; //Port number of socket
		struct in_addr sin_addr; //IP address
		char sin_zero[8]; //nused dont know why...
	};


	WORD sockVersion=MAKEWORD(1,1);
	WSADATA wsaData;
	int nret;
	//initializing Winsock
	WSAStartup(sockVersion, &wsaData);
	//create the listening socket
	SOCKET listeningSocket;
	listeningSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);//AF_INET=adress family; SOCK_STREAM=connection based protocl(TCP);IPPROTO_TCP=TCP protocol type packets

	if (LISTEN_OUTSTANDING == INVALID_SOCKET)
	{
		nret = WSAGetLastError();//get the detail of the error
		//ReportError(nret, "socket()");//report the error with our function
		WSACleanup(); // cleanshut down the
		return 0;
	}
	//use a SOCKADDR_IN struct to fill the address information
	SOCKADDR_IN serverInfo;
	serverInfo.sin_family = AF_INET;
	serverInfo.sin_addr.s_addr = INADDR_ANY;//accept any local addresses will ok
	serverInfo.sin_port = htons(8888);//convert from u_short  to TCP\IP network byte order
	//Bind the socket to our local server address
	nret = bind(listeningSocket, (LPSOCKADDR)&serverInfo, sizeof(struct sockaddr));
	if (nret == SOCKET_ERROR){
		nret = WSAGetLastError();
		//ReportError(nret, "bind()");
		WSACleanup();
		return 0;
	}
	//Make the socket listen
	nret = listen(listeningSocket, 10); // up to 10 connections may wait to be accept() ed
	if (nret == SOCKET_ERROR){
		nret = WSAGetLastError();
		//ReportError(nret, "listen()");
		WSACleanup();
		return 0;
	}
	//Wait for a client 
	SOCKET theClient;
	theClient = accept(listeningSocket, NULL, NULL);//Optionally SOCKADDR_IN;Optionally size of the struct;
	if (theClient == INVALID_SOCKET){
		nret = WSAGetLastError();
		//ReportError(nret, "accept()");
		WSACleanup();
		return 0;
	}
	//Send and recieve from the client here ...
	char buffer[256];// declare a buffer
	ZeroMemory(buffer, 256);
	strcpy_s(buffer, "test  test test");
	nret = send(theClient, buffer, strlen(buffer), 0);

	closesocket(theClient);
	closesocket(listeningSocket);

	//ShutDown Winsock
	WSACleanup();
	return 0;
}

